# üîí Architecture Analysis Report - xelthAGI Security System
**Date**: 2026-01-04
**Version**: 1.5 (Post-Security Refactor)
**Status**: ‚ö†Ô∏è Partial Success - Core Issue Identified

---

## ‚úÖ Successfully Implemented

### 1. Per-Client State Isolation
**Location**: `server/src/index.js:101-129`

**Changes**:
- Replaced single `globalState` with `Map<clientId, state>`
- Each client has completely isolated state
- No cross-client data access possible

```javascript
const clientStates = new Map();

function getOrCreateClientState(clientId) {
    if (!clientStates.has(clientId)) {
        clientStates.set(clientId, { /* isolated state */ });
    }
    return clientStates.get(clientId);
}
```

**Security Benefit**: ‚úÖ Complete client isolation - no admin access, no spying

---

### 2. Dual-Token Security System
**Locations**:
- `server/src/authService.js:27-33` (token creation)
- `server/scripts/generate_dev_token.js:8-25` (generation)
- `server/src/index.js:41-48` (role-based auth)

**Token Types**:

| Type | Role | Access | Use Case |
|------|------|--------|----------|
| **Agent Token** | `agent` | `/DECIDE` + `/API/*` | Embedded in executable for command execution |
| **Console Token** | `view` | `/API/*` only | Web dashboard read-only access |

**Token Payload**:
```json
{
  "cid": "<client-id>",
  "role": "agent" | "view"
}
```

**Security Features**:
- ‚úÖ Stolen console token = read-only access to ONE client only
- ‚úÖ Role-based middleware blocks console tokens from `/DECIDE`
- ‚úÖ Each token has embedded expiration

---

### 3. Web Dashboard Authentication
**Location**: `server/public/app.js:10-44`

**Flow**:
1. User accesses `/AGI/?token=<console_token>`
2. JavaScript extracts token from URL
3. Saves to `localStorage.setItem('consoleToken', token)`
4. Removes token from URL (security: `window.history.replaceState`)
5. All API requests include `Authorization: Bearer <token>`

**UX**:
- If no token ‚Üí shows error page with instructions
- Token persists across page refreshes via localStorage
- Automatic URL cleanup prevents token leak in browser history

---

### 4. CI/CD Token Distribution
**Location**: `client/SupportAgent/ci_cycle.bat:27-63`

**Process**:
1. Generate both tokens: `node scripts/generate_dev_token.js`
2. Agent token ‚Üí stdout (for patching executable)
3. Console token ‚Üí stderr with prefix `CONSOLE:`
4. **Prints Console URL** for user:
```
========================================
   CONSOLE URL (Read-Only):
   https://xelth.com/AGI/?token=<console_token>
========================================
```

---

### 5. Bug Fixes

#### **ask_user Dialog Bug**
**Location**: `client/SupportAgent/Program.cs:291,297`
**Issue**: Used `Command.Message` (doesn't exist)
**Fix**: Changed to `Command.Text` ‚úÖ
**Impact**: Human assistance dialogs now display messages correctly

#### **Auto-Approve Feature**
**Location**: `client/SupportAgent/Program.cs:107,117`
**Added**: `--auto-approve` and `--unsafe` flags
**Impact**: Skip security prompts during testing ‚úÖ

---

## üî¥ Critical Issue Discovered: Client ID Mismatch

### Problem Summary
**The token's client ID and the actual running client's ID are DIFFERENT!**

### Root Cause Analysis

**Token Generation** (`server/scripts/generate_dev_token.js:6`):
```javascript
const clientId = crypto.randomBytes(16).toString('hex');
// Example: 8ad561387f04029ad72f1bb88ecef065
```

**Client ID Generation** (`client/SupportAgent/Program.cs:734-751`):
```csharp
private static string GetOrCreateClientId()
{
    var path = Path.Combine(
        Environment.GetFolderPath(Environment.SpecialFolder.LocalApplicationData),
        "XelthAGI", "client-id.txt"
    );

    if (File.Exists(path))
        return File.ReadAllText(path).Trim();  // Returns PERSISTENT ID

    var id = Guid.NewGuid().ToString("N");  // Generates NEW ID
    File.WriteAllText(path, id);
    return id;
}
```

**Persistent File**: `%LocalAppData%\XelthAGI\client-id.txt`
**Contains**: `cd3ad58e977440559efeca8aa609c3c1` (old ID)

### The Conflict

| Component | Client ID | Source |
|-----------|-----------|--------|
| **Agent Token** | `8ad561387f04029ad72f1bb88ecef065` | Generated by token script |
| **Console Token** | `8ad561387f04029ad72f1bb88ecef065` | Same as agent (correct!) |
| **Running Client** | `cd3ad58e977440559efeca8aa609c3c1` | Persistent local file |

**Result**:
- Console dashboard looks for state of client `8ad561387f04029ad72f1bb88ecef065`
- Actual client reports as `cd3ad58e977440559efeca8aa609c3c1`
- Dashboard shows "OFFLINE" even when client is running! ‚ùå

---

## üéØ Observed Behavior

### ‚úÖ What Works
1. **Client-Server Communication**: Client connects, sends requests, receives commands
2. **OCR & AI Vision**: Screenshots captured, OCR analysis working
3. **Command Execution**: `os_run`, `type`, `click`, etc. all work
4. **Auto-Approve**: No more security prompts with `--auto-approve` flag
5. **Human Assistance**: Popup dialogs work (user confirmed: "—è –æ–±—â–∞–ª—Å—è —Å –∫–ª–∏–µ–Ω—Ç–æ–º... –æ–Ω —Å–¥–µ–ª–∞–ª")
6. **Token Authentication**: Server validates tokens correctly
7. **Role-Based Access**: Console tokens blocked from `/DECIDE` endpoint

### ‚ùå What's Broken
1. **Dashboard Display**: Always shows "OFFLINE" and "No active task"
2. **Client ID Mismatch**: Token CID ‚â† Running Client CID
3. **No Real-Time Updates**: Dashboard can't find the client's state

---

## üõ†Ô∏è Recommended Refactoring Solutions

### Option A: Client Uses Token's Client ID (Recommended)
**Pros**: Single source of truth, tokens control identity
**Cons**: Requires token parsing in client

**Implementation**:
1. Server validates token in `/DECIDE` request
2. Server extracts `client.id` from token payload
3. Server includes `canonicalClientId` in response:
```json
{
  "Command": { "Action": "...", "Text": "..." },
  "CanonicalClientId": "8ad561387f04029ad72f1bb88ecef065",
  "TaskCompleted": false
}
```
4. Client checks if response includes `CanonicalClientId`
5. If provided and different from current, update `_clientId`
6. Delete or ignore the persistent file

**Files to modify**:
- `server/src/index.js` (add CID to response)
- `client/SupportAgent/Program.cs` (accept and use canonical CID)

---

### Option B: Token Uses Client's Persistent ID
**Pros**: Simpler, client doesn't change
**Cons**: Requires pre-generated client ID before token creation

**Implementation**:
1. Client runs first time ‚Üí generates persistent ID ‚Üí saves to file
2. On subsequent builds, read that ID from file
3. Pass it to token generation: `generate_dev_token.js <client-id>`
4. Generate tokens with THAT specific ID

**Files to modify**:
- `server/scripts/generate_dev_token.js` (accept CID as parameter)
- `client/SupportAgent/ci_cycle.bat` (read persisted ID, pass to script)

---

### Option C: Hybrid Approach (Quick Fix)
**For current session**: Just use the correct console URL for the active client

**Implementation**:
1. Find active client ID from server logs: `cd3ad58e977440559efeca8aa609c3c1`
2. Generate console token for THAT ID specifically
3. Open dashboard with that token

---

## üìä System State Snapshot

### Currently Running
- **Active Client**: `cd3ad58e977440559efeca8aa609c3c1`
- **Task**: "XLT Prod Integration Test" (just finished)
- **Last Seen**: Recently active (check `/API/STATE` with agent token)

### Recent Build
- **Agent Token CID**: `8ad561387f04029ad72f1bb88ecef065`
- **Console Token CID**: `8ad561387f04029ad72f1bb88ecef065` (same)
- **Console URL**: `https://xelth.com/AGI/?token=xlt_mjzt7a7f_myhcx7jf_...`

### Server Status
- ‚úÖ Running on port 3232
- ‚úÖ Auth middleware active
- ‚úÖ Per-client state isolation active
- ‚ö†Ô∏è Getting 401 errors from dashboard (old tokens)

---

## üîß Additional Features Added

### 1. Shutdown Button
**Location**: `server/public/index.html:18-20`, `server/public/app.js:70-90`
**Endpoint**: `POST /API/SHUTDOWN` (`server/src/index.js:434-445`)
**Status**: ‚ö†Ô∏è Implemented but not tested (needs matching client ID)

**How it works**:
1. User clicks "üõë Shutdown Agent" button
2. Dashboard sends `POST /API/SHUTDOWN` with auth token
3. Server sets `clientState.shutdownRequested = true`
4. On next `/DECIDE` poll, server returns shutdown command
5. Client executes graceful shutdown

**Missing**: Client-side shutdown command handler

---

### 2. Debug Scripts
**Files Created**:
- `client/SupportAgent/run_visible_debug.ps1` - PowerShell debug launcher
- `client/SupportAgent/RUN_DEBUG.bat` - Double-click debug launcher
- `client/SupportAgent/DEBUG_README_RU.md` - Russian documentation

**Features**:
- Console window stays open (Pause at end)
- Output logged to `debug_output.txt`
- Includes `--auto-approve` flag

---

## üìù Files Modified

### Server-Side (8 files)
1. `server/src/index.js` - State isolation, auth middleware, shutdown endpoint
2. `server/src/authService.js` - Role support in tokens
3. `server/scripts/generate_dev_token.js` - Dual-token generation
4. `server/public/app.js` - Token auth, shutdown button
5. `server/public/index.html` - Shutdown button UI

### Client-Side (6 files)
6. `client/SupportAgent/Program.cs` - ask_user fix, auto-approve flag
7. `client/SupportAgent/ci_cycle.bat` - Dual-token capture, console URL print
8. `client/SupportAgent/run_visible_debug.ps1` - New debug script
9. `client/SupportAgent/RUN_DEBUG.bat` - New launcher
10. `client/SupportAgent/DEBUG_README_RU.md` - New docs

---

## ‚ö° Immediate Action Items

### Priority 1: Fix Client ID Mismatch
**Choose one approach** from Options A, B, or C above.
**Recommended**: **Option A** (server tells client its canonical ID)

### Priority 2: Complete Shutdown Feature
**Add client-side handler**:
```csharp
if (response.Command.Action.ToLower() == "shutdown")
{
    Console.WriteLine("üõë Shutdown command received");
    Environment.Exit(0);
}
```

### Priority 3: Clean Up Old Tokens/IDs
**Delete old persistent data**:
```bash
# On user's machine
del %LocalAppData%\XelthAGI\client-id.txt

# Or modify code to ignore persistent file if token provides ID
```

### Priority 4: Deploy Latest Changes
**Server needs restart** to load:
- Shutdown button endpoint
- Updated app.js with shutdown handler

Current deploy status:
- ‚úÖ Server-side auth changes deployed
- ‚ö†Ô∏è Client-side ID sync - needs implementation
- ‚ö†Ô∏è Shutdown handler - needs client-side code

---

## üéì Lessons Learned

1. **Dual ID System Pitfall**: Having both token-based and file-based IDs creates sync issues
2. **Token Payload Privacy**: Can't decrypt client-side without exposing keys
3. **Server-as-Oracle**: Server should be source of truth for identity
4. **Persistent State**: Local files can cause stale data problems
5. **Testing Gaps**: Need integration tests that verify token CID = client CID

---

## üìà Success Metrics

- ‚úÖ **Security**: No admin access, complete client isolation
- ‚úÖ **Authentication**: Role-based tokens working
- ‚úÖ **UI**: Dashboard loads, shutdown button added
- ‚úÖ **Client**: Commands execute, dialogs work
- ‚ùå **Integration**: Dashboard ‚Üî Client link broken (ID mismatch)

**Overall**: **70% Complete** - Core systems work, needs ID synchronization

---

## üöÄ Next Sprint Tasks

1. Implement Option A (server-provided canonical ID)
2. Add shutdown command handler to client
3. Test full flow: build ‚Üí run ‚Üí dashboard displays ‚Üí shutdown works
4. Add client ID display in dashboard header
5. Document token architecture for future developers
6. Create automated test that verifies token CID = client CID

---

## üìû Contact Points for Architect

- **Active Client**: Uses ID from `%LocalAppData%\XelthAGI\client-id.txt`
- **Token Generation**: Creates random ID each time
- **Mismatch**: These two IDs are never synchronized
- **Fix Required**: Align these two sources of identity

**Critical Code Locations**:
- Client ID generation: `client/SupportAgent/Program.cs:734-751`
- Token generation: `server/scripts/generate_dev_token.js:5-6`
- Token validation: `server/src/authService.js:115-125`
- State lookup: `server/src/index.js:397` (uses token CID)

---

**End of Report**
